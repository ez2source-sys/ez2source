{% extends "base.html" %}

{% block title %}Quick Job - Ez2source{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold">
                        <i data-feather="zap" class="me-2"></i>Quick Job
                        <span class="badge ai-powered-badge ms-2">AI-Powered</span>
                    </h1>
                    <p class="lead text-muted">Discover and apply to jobs instantly with AI assistance</p>
                </div>
                <div>
                    <a href="{{ url_for('candidate_dashboard') }}" class="btn btn-outline-secondary">
                        <i data-feather="arrow-left" class="me-1"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Search -->
    <div class="row mb-4">
        <div class="col">
            <div class="card bg-gradient-primary border-0 shadow-lg">
                <div class="card-body text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title">âš¡ Lightning-Fast Job Search</h5>
                            <p class="card-text opacity-90">Enter keywords, job titles, or describe what you're looking for</p>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <input type="text" class="form-control" id="quickSearchInput" 
                                       placeholder="e.g., Python developer, marketing manager..."
                                       style="border-radius: 25px 0 0 25px;">
                                <button class="btn btn-light text-primary fw-bold" type="button" id="quickSearchBtn"
                                        style="border-radius: 0 25px 25px 0;">
                                    <i data-feather="search" class="me-1"></i>Search
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-success bg-opacity-10 border-success">
                <div class="card-body text-center">
                    <i data-feather="target" class="text-success mb-2" style="width: 30px; height: 30px;"></i>
                    <h4 class="fw-bold text-success">{{ stats.high_match_jobs }}</h4>
                    <p class="mb-0 small text-muted">High Match Jobs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning bg-opacity-10 border-warning">
                <div class="card-body text-center">
                    <i data-feather="zap" class="text-warning mb-2" style="width: 30px; height: 30px;"></i>
                    <h4 class="fw-bold text-warning">{{ stats.quick_apply_ready }}</h4>
                    <p class="mb-0 small text-muted">Quick Apply Ready</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info bg-opacity-10 border-info">
                <div class="card-body text-center">
                    <i data-feather="trending-up" class="text-info mb-2" style="width: 30px; height: 30px;"></i>
                    <h4 class="fw-bold text-info">{{ stats.trending_jobs_count }}</h4>
                    <p class="mb-0 small text-muted">Trending This Week</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary bg-opacity-10 border-secondary">
                <div class="card-body text-center">
                    <i data-feather="bookmark" class="text-secondary mb-2" style="width: 30px; height: 30px;"></i>
                    <h4 class="fw-bold text-secondary">{{ stats.saved_jobs_count }}</h4>
                    <p class="mb-0 small text-muted">Saved Jobs</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Results -->
    <div id="searchResults" class="row mb-4" style="display: none;">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i data-feather="search" class="me-2"></i>Search Results
                        <span id="searchResultsCount" class="badge bg-primary ms-2"></span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="searchResultsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Recommendations -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i data-feather="cpu" class="me-2"></i>AI-Powered Recommendations
                        <span class="badge bg-success ms-2">{{ quick_jobs|length }} jobs</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for job_data in quick_jobs %}
                        <div class="col-lg-6 col-md-12 mb-4">
                            <div class="card h-100 quick-job-card" data-job-id="{{ job_data.job.id }}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title fw-bold">{{ job_data.job.title }}</h6>
                                            <p class="text-muted mb-1">
                                                <i data-feather="briefcase" class="me-1" style="width: 16px; height: 16px;"></i>
                                                {{ job_data.company_info.name }}
                                            </p>
                                            <p class="text-muted mb-2">
                                                <i data-feather="map-pin" class="me-1" style="width: 16px; height: 16px;"></i>
                                                {{ job_data.job.location }}
                                                {% if job_data.job.remote_type != 'on_site' %}
                                                <span class="badge bg-info ms-1">{{ job_data.job.remote_type|replace('_', ' ')|title }}</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                        <div class="text-end">
                                            <div class="mb-2">
                                                <span class="badge bg-{{ 'success' if job_data.match_percentage >= 80 else ('warning' if job_data.match_percentage >= 60 else 'secondary') }}">
                                                    {{ job_data.match_percentage }}% Match
                                                </span>
                                            </div>
                                            <small class="text-muted">{{ job_data.time_ago }}</small>
                                        </div>
                                    </div>
                                    
                                    <!-- Job Highlights -->
                                    <div class="mb-3">
                                        {% for highlight in job_data.highlights %}
                                        <span class="badge bg-light text-dark me-1 mb-1">{{ highlight }}</span>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Job Description Preview -->
                                    <p class="card-text text-muted small">
                                        {{ job_data.job.description[:150] }}...
                                    </p>
                                    
                                    <!-- Quick Actions -->
                                    <div class="d-flex gap-2 flex-wrap">
                                        {% for action in job_data.quick_actions %}
                                        <button class="btn btn-{{ action.variant }} btn-sm quick-action-btn" 
                                                data-action="{{ action.type }}" 
                                                data-job-id="{{ job_data.job.id }}">
                                            <i data-feather="{{ action.icon }}" class="me-1" style="width: 16px; height: 16px;"></i>
                                            {{ action.label }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trending Jobs -->
    {% if trending_jobs %}
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i data-feather="trending-up" class="me-2"></i>Trending Jobs
                        <span class="badge bg-warning ms-2">{{ trending_jobs|length }} jobs</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for trending_data in trending_jobs %}
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card h-100 trending-job-card">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title fw-bold">{{ trending_data.job.title }}</h6>
                                            <p class="text-muted mb-1">
                                                <i data-feather="briefcase" class="me-1" style="width: 16px; height: 16px;"></i>
                                                {{ trending_data.company_name }}
                                            </p>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-danger">ðŸ”¥ Trending</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <small class="text-muted">
                                            <i data-feather="users" class="me-1" style="width: 16px; height: 16px;"></i>
                                            {{ trending_data.applications_count }} applications
                                        </small>
                                        <small class="text-muted ms-2">
                                            <i data-feather="clock" class="me-1" style="width: 16px; height: 16px;"></i>
                                            {{ trending_data.time_ago }}
                                        </small>
                                    </div>
                                    
                                    <div class="d-flex gap-2">
                                        <a href="{{ url_for('job_detail', job_id=trending_data.job.id) }}" class="btn btn-primary btn-sm">
                                            <i data-feather="eye" class="me-1" style="width: 16px; height: 16px;"></i>
                                            View Details
                                        </a>
                                        <button class="btn btn-outline-secondary btn-sm save-job-btn" 
                                                data-job-id="{{ trending_data.job.id }}">
                                            <i data-feather="bookmark" class="me-1" style="width: 16px; height: 16px;"></i>
                                            Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Loading States -->
    <div id="loadingSpinner" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Finding perfect jobs for you...</p>
    </div>

    <!-- Empty State -->
    {% if not quick_jobs and not trending_jobs %}
    <div class="text-center py-5">
        <i data-feather="search" class="mb-3 text-muted" style="width: 64px; height: 64px; opacity: 0.3;"></i>
        <h4 class="text-muted">No Jobs Found</h4>
        <p class="text-muted">Try adjusting your search criteria or complete your profile for better recommendations.</p>
        <a href="{{ url_for('candidate_profile', user_id=current_user.id) }}" class="btn btn-primary">
            <i data-feather="user" class="me-1"></i>Complete Profile
        </a>
    </div>
    {% endif %}
</div>

<!-- JavaScript for Quick Job functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('quickSearchInput');
    const searchBtn = document.getElementById('quickSearchBtn');
    const searchResults = document.getElementById('searchResults');
    const searchResultsContainer = document.getElementById('searchResultsContainer');
    const searchResultsCount = document.getElementById('searchResultsCount');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    // Quick search functionality
    function performQuickSearch() {
        const query = searchInput.value.trim();
        if (!query) return;
        
        // Show loading
        loadingSpinner.style.display = 'block';
        searchResults.style.display = 'none';
        
        // Perform search
        fetch(`/quick-jobs/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displaySearchResults(data.jobs);
                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('Search error:', error);
                loadingSpinner.style.display = 'none';
                showError('Search failed. Please try again.');
            });
    }
    
    function displaySearchResults(jobs) {
        searchResultsContainer.innerHTML = '';
        searchResultsCount.textContent = jobs.length;
        
        if (jobs.length === 0) {
            searchResultsContainer.innerHTML = `
                <div class="text-center py-4">
                    <i data-feather="search" class="mb-3 text-muted" style="width: 48px; height: 48px;"></i>
                    <h5 class="text-muted">No jobs found</h5>
                    <p class="text-muted">Try different keywords or check back later</p>
                </div>
            `;
            feather.replace();
            searchResults.style.display = 'block';
            return;
        }
        
        const jobsHtml = jobs.map(jobData => `
            <div class="col-lg-6 col-md-12 mb-3">
                <div class="card h-100 quick-job-card" data-job-id="${jobData.job.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h6 class="card-title fw-bold">${jobData.job.title}</h6>
                                <p class="text-muted mb-1">
                                    <i data-feather="briefcase" class="me-1" style="width: 16px; height: 16px;"></i>
                                    ${jobData.company_name}
                                </p>
                                <p class="text-muted mb-2">
                                    <i data-feather="map-pin" class="me-1" style="width: 16px; height: 16px;"></i>
                                    ${jobData.job.location}
                                </p>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${jobData.match_score >= 0.8 ? 'success' : (jobData.match_score >= 0.6 ? 'warning' : 'secondary')}">
                                    ${Math.round(jobData.match_score * 100)}% Match
                                </span>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 flex-wrap">
                            ${jobData.quick_actions.map(action => `
                                <button class="btn btn-${action.variant} btn-sm quick-action-btn" 
                                        data-action="${action.type}" 
                                        data-job-id="${jobData.job.id}">
                                    <i data-feather="${action.icon}" class="me-1" style="width: 16px; height: 16px;"></i>
                                    ${action.label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        searchResultsContainer.innerHTML = `<div class="row">${jobsHtml}</div>`;
        feather.replace();
        searchResults.style.display = 'block';
        
        // Re-attach event listeners
        attachQuickActionListeners();
    }
    
    // Quick action handlers
    function attachQuickActionListeners() {
        document.querySelectorAll('.quick-action-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.dataset.action;
                const jobId = this.dataset.jobId;
                handleQuickAction(action, jobId, this);
            });
        });
    }
    
    function handleQuickAction(action, jobId, button) {
        switch (action) {
            case 'quick_apply':
                performQuickApply(jobId, button);
                break;
            case 'save':
                saveJob(jobId, button);
                break;
            case 'unsave':
                unsaveJob(jobId, button);
                break;
            case 'share':
                shareJob(jobId);
                break;
            case 'view_details':
                window.location.href = `/jobs/${jobId}`;
                break;
        }
    }
    
    function performQuickApply(jobId, button) {
        button.disabled = true;
        button.innerHTML = '<div class="spinner-border spinner-border-sm me-1"></div>Applying...';
        
        fetch(`/one-click-application/apply/${jobId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                button.innerHTML = '<i data-feather="check" class="me-1"></i>Applied!';
                button.className = 'btn btn-success btn-sm';
                showSuccess('Application submitted successfully!');
            } else {
                showError(data.message || 'Application failed');
                button.disabled = false;
                button.innerHTML = '<i data-feather="zap" class="me-1"></i>Quick Apply';
            }
        })
        .catch(error => {
            console.error('Apply error:', error);
            showError('Application failed. Please try again.');
            button.disabled = false;
            button.innerHTML = '<i data-feather="zap" class="me-1"></i>Quick Apply';
        });
    }
    
    function saveJob(jobId, button) {
        fetch(`/quick-jobs/save/${jobId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                button.innerHTML = '<i data-feather="bookmark" class="me-1"></i>Saved!';
                button.className = 'btn btn-success btn-sm';
                showSuccess('Job saved successfully!');
            } else {
                showError(data.message || 'Failed to save job');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showError('Failed to save job. Please try again.');
        });
    }
    
    function unsaveJob(jobId, button) {
        fetch(`/quick-jobs/unsave/${jobId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                button.innerHTML = '<i data-feather="bookmark" class="me-1"></i>Save';
                button.className = 'btn btn-outline-primary btn-sm';
                showSuccess('Job unsaved successfully!');
            } else {
                showError(data.message || 'Failed to unsave job');
            }
        })
        .catch(error => {
            console.error('Unsave error:', error);
            showError('Failed to unsave job. Please try again.');
        });
    }
    
    function shareJob(jobId) {
        if (navigator.share) {
            navigator.share({
                title: 'Job Opportunity',
                text: 'Check out this job opportunity I found!',
                url: `${window.location.origin}/jobs/${jobId}`
            });
        } else {
            // Fallback: copy to clipboard
            const url = `${window.location.origin}/jobs/${jobId}`;
            navigator.clipboard.writeText(url).then(() => {
                showSuccess('Job link copied to clipboard!');
            }).catch(() => {
                showError('Failed to copy link');
            });
        }
    }
    
    function showSuccess(message) {
        // Create temporary success alert
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            alert.remove();
        }, 3000);
    }
    
    function showError(message) {
        // Create temporary error alert
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            alert.remove();
        }, 5000);
    }
    
    // Event listeners
    searchBtn.addEventListener('click', performQuickSearch);
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performQuickSearch();
        }
    });
    
    // Initialize quick action listeners
    attachQuickActionListeners();
    
    // Initialize feather icons
    feather.replace();
});
</script>
{% endblock %}