{% extends "base.html" %}

{% block title %}View Cover Letter - Ez2source{% endblock %}

{% block content %}
<div class="container">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-6 fw-bold">
                        Cover Letter: {{ cover_letter.title }}
                        <span class="badge bg-{% if cover_letter.status == 'published' %}success{% elif cover_letter.status == 'draft' %}warning{% else %}secondary{% endif %} ms-2">
                            {{ cover_letter.status.title() if cover_letter.status else 'Draft' }}
                        </span>
                    </h1>
                    <p class="lead text-muted">
                        {{ cover_letter.company_name }} â€¢ {{ cover_letter.position_title }}
                    </p>
                </div>
                <div class="btn-toolbar">
                    <div class="btn-group me-2">
                        <a href="{{ url_for('cover_letters') }}" class="btn btn-outline-secondary">
                            <i data-feather="arrow-left" class="me-1"></i>Back to Cover Letters
                        </a>
                        <a href="{{ url_for('edit_cover_letter', letter_id=cover_letter.id) }}" class="btn btn-primary">
                            <i data-feather="edit" class="me-1"></i>Edit
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cover Letter Content -->
    <div class="row mb-4">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i data-feather="file-text" class="me-2"></i>
                        Cover Letter Content
                    </h5>
                </div>
                <div class="card-body">
                    <div class="cover-letter-content">
                        {{ cover_letter.content | nl2br | safe }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cover Letter Details -->
    <div class="row mb-4">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i data-feather="info" class="me-2"></i>
                        Letter Details
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Template:</strong> 
                                <span class="text-muted">{{ cover_letter.template_type.title() if cover_letter.template_type else 'Custom' }}</span>
                            </div>
                            <div class="mb-3">
                                <strong>Generated by AI:</strong> 
                                <span class="{% if cover_letter.generated_by_ai %}text-success{% else %}text-muted{% endif %}">
                                    {% if cover_letter.generated_by_ai %}
                                        <i data-feather="cpu" class="me-1"></i>Yes
                                    {% else %}
                                        <i data-feather="edit" class="me-1"></i>Manual
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <strong>Created:</strong> 
                                <span class="text-muted">{{ cover_letter.created_at.strftime('%B %d, %Y') }}</span>
                            </div>
                            <div class="mb-3">
                                <strong>Last Updated:</strong> 
                                <span class="text-muted">{{ cover_letter.updated_at.strftime('%B %d, %Y') if cover_letter.updated_at else cover_letter.created_at.strftime('%B %d, %Y') }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i data-feather="settings" class="me-2"></i>
                        Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{{ url_for('edit_cover_letter', letter_id=cover_letter.id) }}" class="btn btn-primary">
                            <i data-feather="edit" class="me-2"></i>Edit Cover Letter
                        </a>
                        <button type="button" class="btn btn-outline-info" onclick="previewCoverLetter()">
                            <i data-feather="eye" class="me-2"></i>Preview
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="downloadCoverLetter()">
                            <i data-feather="download" class="me-2"></i>Download PDF
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="showAlert('Analysis feature coming soon!', 'info')">
                            <i data-feather="cpu" class="me-2"></i>AI Analysis
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="deleteCoverLetter()">
                            <i data-feather="trash-2" class="me-2"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function previewCoverLetter() {
    const content = {{ cover_letter.content | tojson }};
    const title = {{ cover_letter.title | tojson }};
    const company = {{ cover_letter.company_name | tojson }};
    const position = {{ cover_letter.position_title | tojson }};
    
    const previewWindow = window.open('', '_blank');
    previewWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Cover Letter Preview - ${title}</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
                .header { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
                .content { white-space: pre-wrap; }
                .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; }
                @media print { body { margin: 0; padding: 20px; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${title}</h1>
                <p><strong>Company:</strong> ${company}</p>
                <p><strong>Position:</strong> ${position}</p>
            </div>
            <div class="content">${content}</div>
            <div class="footer">
                <p><small>Generated by Ez2source - ${new Date().toLocaleDateString()}</small></p>
            </div>
        </body>
        </html>
    `);
    previewWindow.document.close();
}

function downloadCoverLetter() {
    const content = {{ cover_letter.content | tojson }};
    const title = {{ cover_letter.title | tojson }};
    const company = {{ cover_letter.company_name | tojson }};
    const position = {{ cover_letter.position_title | tojson }};
    
    const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Cover Letter - ${title}</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
                .header { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; }
                .content { white-space: pre-wrap; }
                .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${title}</h1>
                <p><strong>Company:</strong> ${company}</p>
                <p><strong>Position:</strong> ${position}</p>
            </div>
            <div class="content">${content}</div>
            <div class="footer">
                <p><small>Generated by Ez2source - ${new Date().toLocaleDateString()}</small></p>
            </div>
        </body>
        </html>
    `;
    
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_cover_letter.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function deleteCoverLetter() {
    if (confirm('Are you sure you want to delete this cover letter? This action cannot be undone.')) {
        // Create a form and submit it using POST method
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_cover_letter", letter_id=cover_letter.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}

function showAlert(message, type) {
    // Create a simple alert div
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}

// Initialize Feather Icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>

{% endblock %}

{% block scripts %}
<style>
.cover-letter-content {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #333;
    background: #f8f9fa;
    padding: 2rem;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    white-space: pre-wrap;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border-radius: 0.375rem;
}

.card-header {
    background: white;
    border-bottom: 1px solid #e9ecef;
    padding: 1rem 1.5rem;
}

.card-body {
    padding: 1.5rem;
}

.btn-group .btn {
    border-radius: 0.375rem;
}

.btn-group .btn + .btn {
    margin-left: 0.5rem;
}

.display-6 {
    font-size: 2rem;
    font-weight: 600;
}

.lead {
    font-size: 1.1rem;
    font-weight: 300;
}

.text-muted {
    color: #6c757d;
}

@media (max-width: 768px) {
    .display-6 {
        font-size: 1.5rem;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    .btn-toolbar {
        justify-content: flex-start;
    }
}
</style>

<script>
{% endblock %}