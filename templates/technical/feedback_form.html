{% extends "base.html" %}

{% block title %}Technical Interview Feedback - Ez2source{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <a href="{{ url_for('technical_person_dashboard') }}" class="btn btn-outline-secondary me-3">
                        <i data-feather="arrow-left" class="me-1"></i>Back to Dashboard
                    </a>
                    <h2 class="d-inline">
                        <i data-feather="edit" class="me-2"></i>Technical Interview Feedback
                    </h2>
                </div>
                <div>
                    <a href="{{ url_for('technical_candidate_profile', candidate_id=assignment.candidate_id) }}" 
                       class="btn btn-outline-info">
                        <i data-feather="user" class="me-1"></i>View Candidate Profile
                    </a>
                </div>
            </div>

            <!-- Interview Details -->
            <div class="card mb-4 bg-light">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Candidate:</strong><br>
                            {{ assignment.candidate.first_name or 'Unknown' }} {{ assignment.candidate.last_name or '' }}
                        </div>
                        <div class="col-md-3">
                            <strong>Position:</strong><br>
                            {{ assignment.interview.title }}
                        </div>
                        <div class="col-md-3">
                            <strong>Interview Date:</strong><br>
                            {{ assignment.interview_date.strftime('%B %d, %Y at %I:%M %p') }}
                        </div>
                        <div class="col-md-3">
                            <strong>Status:</strong><br>
                            <span class="badge bg-{{ 'warning' if assignment.status == 'pending' else 'success' }}">
                                {{ assignment.status.title() }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feedback Form -->
            <form method="POST" action="{{ url_for('submit_technical_feedback', assignment_id=assignment.id) }}">
                <div class="row">
                    <!-- Left Column: Main Feedback -->
                    <div class="col-md-8">
                        <!-- Decision -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i data-feather="check-circle" class="me-2"></i>Interview Decision *
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check form-check-custom">
                                            <input class="form-check-input" type="radio" name="decision" value="selected" 
                                                   id="decision_selected" {{ 'checked' if existing_feedback and existing_feedback.decision == 'selected' else '' }}>
                                            <label class="form-check-label text-success" for="decision_selected">
                                                <i data-feather="check" class="me-1"></i><strong>Selected</strong>
                                                <small class="d-block text-muted">Candidate passes technical interview</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-check-custom">
                                            <input class="form-check-input" type="radio" name="decision" value="rejected" 
                                                   id="decision_rejected" {{ 'checked' if existing_feedback and existing_feedback.decision == 'rejected' else '' }}>
                                            <label class="form-check-label text-danger" for="decision_rejected">
                                                <i data-feather="x" class="me-1"></i><strong>Rejected</strong>
                                                <small class="d-block text-muted">Candidate does not meet requirements</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-check-custom">
                                            <input class="form-check-input" type="radio" name="decision" value="second_round" 
                                                   id="decision_second_round" {{ 'checked' if existing_feedback and existing_feedback.decision == 'second_round' else '' }}>
                                            <label class="form-check-label text-warning" for="decision_second_round">
                                                <i data-feather="refresh-cw" class="me-1"></i><strong>Second Round</strong>
                                                <small class="d-block text-muted">Requires additional interview</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Technical Comments -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i data-feather="code" class="me-2"></i>Technical Assessment
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="technical_comments" class="form-label">Technical Skills & Problem Solving</label>
                                    <textarea class="form-control" id="technical_comments" name="technical_comments" 
                                              rows="5" placeholder="Evaluate the candidate's technical knowledge, coding skills, problem-solving approach, and ability to work with relevant technologies...">{{ existing_feedback.technical_comments if existing_feedback else '' }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Communication Comments -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i data-feather="message-circle" class="me-2"></i>Communication & Collaboration
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="communication_comments" class="form-label">Communication Skills & Team Fit</label>
                                    <textarea class="form-control" id="communication_comments" name="communication_comments" 
                                              rows="4" placeholder="Assess the candidate's ability to communicate technical concepts, ask questions, explain their thinking, and collaborate effectively...">{{ existing_feedback.communication_comments if existing_feedback else '' }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Overall Comments -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i data-feather="file-text" class="me-2"></i>Overall Assessment
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="overall_comments" class="form-label">Summary & Recommendations</label>
                                    <textarea class="form-control" id="overall_comments" name="overall_comments" 
                                              rows="5" placeholder="Provide an overall summary of the interview, key strengths, areas for improvement, and your hiring recommendation...">{{ existing_feedback.overall_comments if existing_feedback else '' }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Second Round Notes (conditional) -->
                        <div class="card mb-4" id="second_round_section" style="display: none;">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0">
                                    <i data-feather="refresh-cw" class="me-2"></i>Second Round Interview Notes
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="second_round_notes" class="form-label">Specific Areas to Focus On</label>
                                    <textarea class="form-control" id="second_round_notes" name="second_round_notes" 
                                              rows="3" placeholder="Specify what topics, skills, or questions should be covered in the second round interview...">{{ existing_feedback.second_round_notes if existing_feedback else '' }}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Ratings & Options -->
                    <div class="col-md-4">
                        <!-- Skills Ratings -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i data-feather="star" class="me-2"></i>Skills Rating (1-5)
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Technical Skills Rating -->
                                <div class="mb-3">
                                    <label for="technical_skills_rating" class="form-label">Technical Skills</label>
                                    <select class="form-select" id="technical_skills_rating" name="technical_skills_rating">
                                        <option value="">Select rating...</option>
                                        {% for i in range(1, 6) %}
                                        <option value="{{ i }}" {{ 'selected' if existing_feedback and existing_feedback.technical_skills_rating == i else '' }}>
                                            {{ i }} - {{ ['Poor', 'Below Average', 'Average', 'Good', 'Excellent'][i-1] }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Problem Solving Rating -->
                                <div class="mb-3">
                                    <label for="problem_solving_rating" class="form-label">Problem Solving</label>
                                    <select class="form-select" id="problem_solving_rating" name="problem_solving_rating">
                                        <option value="">Select rating...</option>
                                        {% for i in range(1, 6) %}
                                        <option value="{{ i }}" {{ 'selected' if existing_feedback and existing_feedback.problem_solving_rating == i else '' }}>
                                            {{ i }} - {{ ['Poor', 'Below Average', 'Average', 'Good', 'Excellent'][i-1] }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Communication Rating -->
                                <div class="mb-3">
                                    <label for="communication_rating" class="form-label">Communication</label>
                                    <select class="form-select" id="communication_rating" name="communication_rating">
                                        <option value="">Select rating...</option>
                                        {% for i in range(1, 6) %}
                                        <option value="{{ i }}" {{ 'selected' if existing_feedback and existing_feedback.communication_rating == i else '' }}>
                                            {{ i }} - {{ ['Poor', 'Below Average', 'Average', 'Good', 'Excellent'][i-1] }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>

                                <!-- Cultural Fit Rating -->
                                <div class="mb-3">
                                    <label for="cultural_fit_rating" class="form-label">Cultural Fit</label>
                                    <select class="form-select" id="cultural_fit_rating" name="cultural_fit_rating">
                                        <option value="">Select rating...</option>
                                        {% for i in range(1, 6) %}
                                        <option value="{{ i }}" {{ 'selected' if existing_feedback and existing_feedback.cultural_fit_rating == i else '' }}>
                                            {{ i }} - {{ ['Poor', 'Below Average', 'Average', 'Good', 'Excellent'][i-1] }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Interview Details -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i data-feather="clock" class="me-2"></i>Interview Details
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label for="interview_duration_minutes" class="form-label">Duration (minutes)</label>
                                    <input type="number" class="form-control" id="interview_duration_minutes" 
                                           name="interview_duration_minutes" min="15" max="180" step="5"
                                           value="{{ existing_feedback.interview_duration_minutes if existing_feedback else '' }}"
                                           placeholder="e.g., 60">
                                </div>
                            </div>
                        </div>

                        <!-- AI Assistance -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i data-feather="cpu" class="me-2"></i>AI Assistance
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="used_ai_assistance" 
                                           name="used_ai_assistance" {{ 'checked' if existing_feedback and existing_feedback.used_ai_assistance else '' }}>
                                    <label class="form-check-label" for="used_ai_assistance">
                                        Generate AI summary of this feedback
                                    </label>
                                    <small class="form-text text-muted">
                                        AI will analyze your feedback and provide additional insights
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="card">
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i data-feather="save" class="me-2"></i>
                                        {{ 'Update Feedback' if existing_feedback else 'Submit Feedback' }}
                                    </button>
                                    <a href="{{ url_for('technical_person_dashboard') }}" class="btn btn-outline-secondary">
                                        <i data-feather="x" class="me-1"></i>Cancel
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Initialize Feather icons
feather.replace();

// Show/hide second round section based on decision
function toggleSecondRoundSection() {
    const secondRoundRadio = document.getElementById('decision_second_round');
    const secondRoundSection = document.getElementById('second_round_section');
    
    if (secondRoundRadio.checked) {
        secondRoundSection.style.display = 'block';
    } else {
        secondRoundSection.style.display = 'none';
    }
}

// Add event listeners for decision radio buttons
document.querySelectorAll('input[name="decision"]').forEach(radio => {
    radio.addEventListener('change', toggleSecondRoundSection);
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    toggleSecondRoundSection();
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const decision = document.querySelector('input[name="decision"]:checked');
    
    if (!decision) {
        e.preventDefault();
        alert('Please select a decision (Selected/Rejected/Second Round)');
        return false;
    }
    
    // Confirm submission
    const confirmMessage = `Are you sure you want to submit this feedback with decision: ${decision.value.replace('_', ' ').toUpperCase()}?`;
    if (!confirm(confirmMessage)) {
        e.preventDefault();
        return false;
    }
});
</script>

<style>
.form-check-custom .form-check-label {
    cursor: pointer;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    display: block;
    transition: all 0.2s;
}

.form-check-custom .form-check-input:checked + .form-check-label {
    background-color: rgba(var(--bs-primary-rgb), 0.1);
    border-color: var(--bs-primary);
}

.form-check-custom .form-check-label:hover {
    background-color: rgba(var(--bs-secondary-rgb), 0.05);
}
</style>
{% endblock %}