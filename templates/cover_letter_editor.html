{% extends "base.html" %}

{% block title %}Edit Cover Letter - {{ job.title }}{% endblock %}

{% block content %}
<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-pulse {
    animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}

.progress-bar-animated {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    0% { background-position: 0 0; }
    100% { background-position: 40px 0; }
}

.ai-processing {
    background: linear-gradient(45deg, #667eea, #764ba2);
    background-size: 400% 400%;
    animation: gradient-shift 3s ease infinite;
}

@keyframes gradient-shift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
</style>
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-6 fw-bold">
                        <i data-feather="edit-3" class="me-2"></i>
                        Edit Cover Letter
                    </h1>
                    <p class="lead text-muted">
                        Customize your cover letter for {{ job.title }} at {{ job.company.name }}
                    </p>
                </div>
                <div class="text-end">
                    <a href="{{ url_for('job_detail', job_id=job.id) }}" class="btn btn-outline-secondary">
                        <i data-feather="arrow-left" class="me-1"></i>
                        Back to Job
                    </a>
                </div>
            </div>

            <!-- Job Information Card -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="card-title mb-1">{{ job.title }}</h5>
                            <p class="text-muted mb-2">
                                <i data-feather="briefcase" class="me-1"></i>{{ job.company.name }}
                                {% if job.location %}
                                <span class="mx-2">•</span>
                                <i data-feather="map-pin" class="me-1"></i>{{ job.location }}
                                {% endif %}
                            </p>
                            {% if job.salary_min or job.salary_max %}
                            <p class="text-success mb-0">
                                <i data-feather="dollar-sign" class="me-1"></i>
                                {% if job.salary_min %}${{ "{:,}".format(job.salary_min) }}{% endif %}
                                {% if job.salary_min and job.salary_max %} - {% endif %}
                                {% if job.salary_max %}${{ "{:,}".format(job.salary_max) }}{% endif %}
                                {{ job.salary_currency }}/year
                            </p>
                            {% endif %}
                        </div>
                        <div class="col-md-4 text-end">
                            {% if match_score %}
                            <div class="badge bg-success fs-6 p-2">
                                <i data-feather="target" class="me-1"></i>
                                {{ "%.1f"|format(match_score) }}% Match
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cover Letter Editor -->
            <div class="row">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i data-feather="file-text" class="me-2"></i>
                                    Cover Letter Editor
                                </h5>
                                <div class="btn-group" role="group">
                                    <button type="button" id="generateBtn" class="btn btn-sm btn-outline-primary" onclick="generateAICoverLetter()">
                                        <i data-feather="refresh-cw" class="me-1"></i>
                                        Regenerate
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="previewCoverLetter()">
                                        <i data-feather="eye" class="me-1"></i>
                                        Preview
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- AI Processing Progress Bar -->
                            <div id="aiProgressBar" class="progress mb-3" style="display: none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated ai-processing" 
                                     role="progressbar" style="width: 0%" 
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    <span id="progressText">Initializing AI...</span>
                                </div>
                            </div>
                            
                            <form id="coverLetterForm" action="{{ url_for('save_cover_letter', job_id=job.id) }}" method="POST">
                                <div class="mb-3">
                                    <label for="coverLetterText" class="form-label">Cover Letter Content</label>
                                    <textarea class="form-control" id="coverLetterText" name="cover_letter" rows="20" 
                                              placeholder="Your cover letter content will appear here...">{{ cover_letter_text or '' }}</textarea>
                                    <div class="form-text">
                                        <span id="charCount">0</span> characters
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="coverLetterTitle" class="form-label">Cover Letter Title</label>
                                    <input type="text" class="form-control" id="coverLetterTitle" name="title" 
                                           value="{{ cover_letter_title or 'Cover Letter for ' + job.title }}" 
                                           placeholder="Enter a title for your cover letter">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="templateType" class="form-label">Template Style</label>
                                    <select class="form-select" id="templateType" name="template_type">
                                        <option value="custom" selected>Custom</option>
                                        <option value="professional">Professional</option>
                                        <option value="enthusiastic">Enthusiastic</option>
                                        <option value="technical">Technical</option>
                                    </select>
                                </div>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button type="button" class="btn btn-outline-secondary" onclick="saveDraft()">
                                        <i data-feather="save" class="me-1"></i>
                                        Save Draft
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i data-feather="check" class="me-1"></i>
                                        Save & Apply
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- Writing Tips -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i data-feather="lightbulb" class="me-2"></i>
                                Writing Tips
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h6 class="text-primary">Structure</h6>
                                <ul class="list-unstyled small">
                                    <li>• Opening: State the position you're applying for</li>
                                    <li>• Body: Highlight relevant experience and skills</li>
                                    <li>• Closing: Express interest and next steps</li>
                                </ul>
                            </div>
                            <div class="mb-3">
                                <h6 class="text-primary">Key Points</h6>
                                <ul class="list-unstyled small">
                                    <li>• Customize for each job application</li>
                                    <li>• Show knowledge of the company</li>
                                    <li>• Use specific examples from your experience</li>
                                    <li>• Keep it concise (3-4 paragraphs)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AI Generator -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i data-feather="zap" class="me-2"></i>
                                AI Generator
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="toneSelect" class="form-label small">Tone</label>
                                <select class="form-select form-select-sm" id="toneSelect">
                                    <option value="professional">Professional</option>
                                    <option value="enthusiastic">Enthusiastic</option>
                                    <option value="technical">Technical</option>
                                    <option value="creative">Creative</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="keyPoints" class="form-label small">Key Points to Include</label>
                                <textarea class="form-control form-control-sm" id="keyPoints" rows="3" 
                                          placeholder="Enter key points you want to highlight..."></textarea>
                            </div>
                            <div class="d-grid">
                                <button type="button" id="generateBtn" class="btn btn-primary btn-sm" onclick="generateAICoverLetter()">
                                    <i data-feather="cpu" class="me-1"></i>
                                    Generate with AI
                                </button>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div id="aiProgressBar" class="mt-3" style="display: none;">
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: 0%" 
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                                <div id="progressText" class="text-muted small text-center">
                                    Initializing AI generation...
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Templates -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">
                                <i data-feather="clipboard" class="me-2"></i>
                                Quick Templates
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadTemplate('opening')">
                                    Opening Paragraph
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadTemplate('experience')">
                                    Experience Highlight
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="loadTemplate('closing')">
                                    Closing Paragraph
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Cover Letter Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent" class="cover-letter-preview">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="copyToClipboard()">
                    <i data-feather="copy" class="me-1"></i>
                    Copy to Clipboard
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loadingText">Generating cover letter...</h5>
                <p class="text-muted mb-0">Please wait while AI creates your personalized cover letter</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.cover-letter-preview {
    white-space: pre-wrap;
    line-height: 1.6;
    font-family: 'Times New Roman', serif;
    font-size: 14px;
    color: #333;
    background: #fff;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.card-header {
    background-color: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6;
}

#coverLetterText {
    font-family: 'Times New Roman', serif;
    font-size: 14px;
    line-height: 1.6;
    resize: vertical;
    min-height: 400px;
}

.ai-powered-badge {
    background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.btn-group .btn {
    border-radius: 0.375rem;
}

.btn-group .btn:not(:last-child) {
    margin-right: 0.5rem;
}

.form-text {
    font-size: 0.875rem;
    color: #6c757d;
}

.list-unstyled li {
    margin-bottom: 0.25rem;
}

.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize Feather icons
feather.replace();

// Character count update
const coverLetterText = document.getElementById('coverLetterText');
const charCount = document.getElementById('charCount');

function updateCharCount() {
    const count = coverLetterText.value.length;
    charCount.textContent = count;
    
    // Color coding based on length
    if (count < 500) {
        charCount.className = 'text-warning';
    } else if (count > 2000) {
        charCount.className = 'text-danger';
    } else {
        charCount.className = 'text-success';
    }
}

coverLetterText.addEventListener('input', updateCharCount);
updateCharCount(); // Initial count

// Auto-save functionality
let autoSaveTimeout;
function autoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        saveDraft();
    }, 5000); // Auto-save after 5 seconds of inactivity
}

coverLetterText.addEventListener('input', autoSave);

// Loading message functions
function showLoadingMessage(message) {
    const loadingText = document.getElementById('loadingText');
    if (loadingText) {
        loadingText.textContent = message;
    }
}

function hideLoadingMessage() {
    const loadingModal = document.getElementById('loadingModal');
    if (loadingModal) {
        const modal = bootstrap.Modal.getInstance(loadingModal);
        if (modal) {
            modal.hide();
        }
    }
}

// Save draft
function saveDraft() {
    const formData = new FormData();
    formData.append('cover_letter', coverLetterText.value);
    formData.append('title', document.getElementById('coverLetterTitle').value);
    formData.append('template_type', document.getElementById('templateType').value);
    formData.append('is_draft', 'true');
    
    fetch(`{{ url_for('save_cover_letter', job_id=job.id) }}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Draft saved successfully', 'success');
        }
    })
    .catch(error => {
        console.error('Auto-save error:', error);
    });
}

// Toast notification function
function showToast(message, type = 'info') {
    const toastHTML = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Add toast to container
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    // Show the toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// Generate AI cover letter
function generateAICoverLetter() {
    const generateBtn = document.getElementById('generateBtn');
    const originalText = generateBtn.innerHTML;
    
    // Show loading state on button
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i data-feather="loader" class="me-2 spin"></i>Generating...';
    
    // Show loading modal
    const loadingModal = document.getElementById('loadingModal');
    if (loadingModal) {
        const modal = new bootstrap.Modal(loadingModal);
        modal.show();
    }
    
    // Show progress bar
    const progressBar = document.getElementById('aiProgressBar');
    const progressBarFill = progressBar.querySelector('.progress-bar');
    const progressText = document.getElementById('progressText');
    
    progressBar.style.display = 'block';
    
    // Progress stages with timing
    const stages = [
        { progress: 20, text: 'Analyzing job requirements...', duration: 2000 },
        { progress: 40, text: 'Reviewing your profile...', duration: 2000 },
        { progress: 60, text: 'Crafting personalized content...', duration: 3000 },
        { progress: 80, text: 'Finalizing your cover letter...', duration: 2000 },
        { progress: 100, text: 'Almost done...', duration: 1000 }
    ];
    
    let currentStage = 0;
    
    function updateProgress() {
        if (currentStage < stages.length) {
            const stage = stages[currentStage];
            progressBarFill.style.width = stage.progress + '%';
            progressBarFill.setAttribute('aria-valuenow', stage.progress);
            progressText.textContent = stage.text;
            
            showLoadingMessage(stage.text);
            
            setTimeout(() => {
                currentStage++;
                updateProgress();
            }, stage.duration);
        }
    }
    
    updateProgress();
    
    const tone = document.getElementById('toneSelect').value;
    const keyPoints = document.getElementById('keyPoints').value;
    
    fetch(`{{ url_for('generate_cover_letter_editor', job_id=job.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tone: tone,
            key_points: keyPoints,
            template_type: document.getElementById('templateType').value
        })
    })
    .then(response => response.json())
    .then(data => {
        // Complete the progress bar
        progressBarFill.style.width = '100%';
        progressText.textContent = 'Complete!';
        
        setTimeout(() => {
            progressBar.style.display = 'none';
            hideLoadingMessage();
            
            if (data.success) {
                document.getElementById('coverLetterText').value = data.cover_letter;
                document.getElementById('coverLetterTitle').value = data.title;
                updateCharCount();
                showToast('Cover letter generated successfully!', 'success');
            } else {
                showToast('Error generating cover letter: ' + data.error, 'error');
            }
        }, 1000);
    })
    .catch(error => {
        progressBar.style.display = 'none';
        hideLoadingMessage();
        console.error('Error:', error);
        showToast('Failed to generate cover letter. Please try again.', 'error');
    })
    .finally(() => {
        generateBtn.disabled = false;
        generateBtn.innerHTML = originalText;
        feather.replace();
    });
}

// Generate new cover letter
function generateNewCoverLetter() {
    if (confirm('This will replace your current cover letter. Are you sure?')) {
        generateAICoverLetter();
    }
}

// Preview cover letter
function previewCoverLetter() {
    const content = document.getElementById('coverLetterText').value;
    const formattedContent = content.replace(/\n/g, '<br>');
    
    document.getElementById('previewContent').innerHTML = formattedContent;
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

// Copy to clipboard
function copyToClipboard() {
    const content = document.getElementById('coverLetterText').value;
    navigator.clipboard.writeText(content).then(() => {
        showToast('Cover letter copied to clipboard!', 'success');
    });
}

// Load template
function loadTemplate(type) {
    const templates = {
        opening: `Dear Hiring Manager,

I am writing to express my strong interest in the ${document.querySelector('h5.card-title').textContent} position at ${document.querySelector('.text-muted').textContent.split('•')[0].trim()}. With my extensive experience in [relevant field] and proven track record of [key achievement], I am confident that I would be a valuable addition to your team.`,
        
        experience: `In my previous role as [previous position], I successfully [specific achievement]. This experience has equipped me with [relevant skills] that directly align with the requirements of this position. I am particularly drawn to [specific aspect of the job/company] because [reason].`,
        
        closing: `I would welcome the opportunity to discuss how my skills and enthusiasm can contribute to your team's continued success. Thank you for considering my application. I look forward to hearing from you soon.

Best regards,
[Your Name]`
    };
    
    const currentText = document.getElementById('coverLetterText').value;
    const template = templates[type];
    
    if (currentText.trim() === '') {
        document.getElementById('coverLetterText').value = template;
    } else {
        document.getElementById('coverLetterText').value = currentText + '\n\n' + template;
    }
    
    updateCharCount();
    showToast('Template added successfully!', 'success');
}

// Show toast notification
function showToast(message, type = 'info') {
    // Simple toast implementation
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}

// Show loading message
function showLoadingMessage(message) {
    let loadingDiv = document.getElementById('loadingMessage');
    if (!loadingDiv) {
        loadingDiv = document.createElement('div');
        loadingDiv.id = 'loadingMessage';
        loadingDiv.className = 'alert alert-info d-flex align-items-center position-fixed';
        loadingDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
        loadingDiv.innerHTML = `
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span id="loadingText">${message}</span>
        `;
        document.body.appendChild(loadingDiv);
    } else {
        document.getElementById('loadingText').textContent = message;
    }
}

// Hide loading message
function hideLoadingMessage() {
    const loadingDiv = document.getElementById('loadingMessage');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// Form submission
document.getElementById('coverLetterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Cover letter saved successfully!', 'success');
            
            // Redirect to job application or job detail page
            setTimeout(() => {
                window.location.href = data.redirect_url || `{{ url_for('job_detail', job_id=job.id) }}`;
            }, 1500);
        } else {
            showToast('Error saving cover letter: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to save cover letter. Please try again.', 'error');
    });
});
</script>
{% endblock %}