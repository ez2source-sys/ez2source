{% extends "base.html" %}

{% block title %}Edit Cover Letter - Ez2source{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('cover_letters') }}">Cover Letters</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Edit Cover Letter</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h3 fw-bold">Edit Cover Letter</h1>
                    <p class="text-muted">Update your cover letter content and settings</p>
                </div>
                <div>
                    <a href="{{ url_for('cover_letters') }}" class="btn btn-outline-secondary">
                        <i data-feather="arrow-left" class="me-1"></i>Back to Cover Letters
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Cover Letter Edit Form -->
    <div class="row">
        <div class="col-lg-8">
            <form method="POST" action="{{ url_for('update_cover_letter', letter_id=cover_letter.id) }}" id="editCoverLetterForm">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Cover Letter Details</h5>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i data-feather="save" class="me-1"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Cover Letter Information -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="title" class="form-label">Cover Letter Title</label>
                                <input type="text" class="form-control" id="title" name="title" 
                                       value="{{ cover_letter.title }}" required>
                            </div>
                        </div>

                        <!-- Job Information -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="position_title" class="form-label">Position Title</label>
                                <input type="text" class="form-control" id="position_title" name="position_title" 
                                       value="{{ cover_letter.position_title }}" required>
                            </div>
                            <div class="col-md-6">
                                <label for="company_name" class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="company_name" name="company_name" 
                                       value="{{ cover_letter.company_name }}" required>
                            </div>
                        </div>

                        <!-- Template and Tone -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="template_type" class="form-label">Template Type</label>
                                <select class="form-select" id="template_type" name="template_type">
                                    <option value="custom" {% if cover_letter.template_type == 'custom' %}selected{% endif %}>Custom</option>
                                    <option value="google" {% if cover_letter.template_type == 'google' %}selected{% endif %}>Google</option>
                                    <option value="amazon" {% if cover_letter.template_type == 'amazon' %}selected{% endif %}>Amazon</option>
                                    <option value="tesla" {% if cover_letter.template_type == 'tesla' %}selected{% endif %}>Tesla</option>
                                    <option value="meta" {% if cover_letter.template_type == 'meta' %}selected{% endif %}>Meta</option>
                                    <option value="microsoft" {% if cover_letter.template_type == 'microsoft' %}selected{% endif %}>Microsoft</option>
                                    <option value="frontend_developer" {% if cover_letter.template_type == 'frontend_developer' %}selected{% endif %}>Frontend Developer</option>
                                    <option value="backend_developer" {% if cover_letter.template_type == 'backend_developer' %}selected{% endif %}>Backend Developer</option>
                                    <option value="product_manager" {% if cover_letter.template_type == 'product_manager' %}selected{% endif %}>Product Manager</option>
                                    <option value="data_scientist" {% if cover_letter.template_type == 'data_scientist' %}selected{% endif %}>Data Scientist</option>
                                    <option value="devops_engineer" {% if cover_letter.template_type == 'devops_engineer' %}selected{% endif %}>DevOps Engineer</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="tone" class="form-label">Tone</label>
                                <select class="form-select" id="tone" name="tone">
                                    <option value="professional" {% if cover_letter.tone == 'professional' %}selected{% endif %}>Professional</option>
                                    <option value="enthusiastic" {% if cover_letter.tone == 'enthusiastic' %}selected{% endif %}>Enthusiastic</option>
                                    <option value="technical" {% if cover_letter.tone == 'technical' %}selected{% endif %}>Technical</option>
                                </select>
                            </div>
                        </div>

                        <!-- Cover Letter Content -->
                        <div class="mb-3">
                            <label for="content" class="form-label">Cover Letter Content</label>
                            <textarea class="form-control" id="content" name="content" rows="15" required>{{ cover_letter.content }}</textarea>
                        </div>

                        <!-- Status -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="draft" {% if cover_letter.status == 'draft' %}selected{% endif %}>Draft</option>
                                    <option value="completed" {% if cover_letter.status == 'completed' %}selected{% endif %}>Completed</option>
                                    <option value="sent" {% if cover_letter.status == 'sent' %}selected{% endif %}>Sent</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="notes" class="form-label">Notes (Optional)</label>
                                <input type="text" class="form-control" id="notes" name="notes" 
                                       value="{{ cover_letter.notes or '' }}" placeholder="Add any notes...">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Cover Letter Stats -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0">Cover Letter Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="p-2">
                                <div class="h4 text-primary mb-0">{{ cover_letter.content|length }}</div>
                                <small class="text-muted">Characters</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2">
                                <div class="h4 text-success mb-0">{{ cover_letter.content.split()|length }}</div>
                                <small class="text-muted">Words</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2">
                                <div class="h4 text-info mb-0">{{ cover_letter.content.split('.')|length - 1 }}</div>
                                <small class="text-muted">Sentences</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h6 class="mb-0">Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="previewCoverLetter()">
                            <i data-feather="eye" class="me-1"></i>Preview
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="downloadCoverLetter()">
                            <i data-feather="download" class="me-1"></i>Download PDF
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="showAlert('Analysis feature coming soon!', 'info')">
                            <i data-feather="cpu" class="me-1"></i>AI Analysis
                        </button>
                        <hr class="my-2">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteCoverLetter()">
                            <i data-feather="trash-2" class="me-1"></i>Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Processing your request...</p>
            </div>
        </div>
    </div>
</div>

<script>


function previewCoverLetter() {
    const content = document.getElementById('content').value;
    const previewWindow = window.open('', '_blank');
    previewWindow.document.write(`
        <html>
            <head>
                <title>Cover Letter Preview</title>
                <style>
                    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .content { white-space: pre-wrap; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Cover Letter Preview</h1>
                    <p><strong>${document.getElementById('position_title').value}</strong> at <strong>${document.getElementById('company_name').value}</strong></p>
                </div>
                <div class="content">${content}</div>
            </body>
        </html>
    `);
}

function downloadCoverLetter() {
    const content = document.getElementById('content').value;
    const positionTitle = document.getElementById('position_title').value;
    const companyName = document.getElementById('company_name').value;
    
    // Create a simple text file download
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Cover_Letter_${positionTitle}_${companyName}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}



function deleteCoverLetter() {
    if (confirm('Are you sure you want to delete this cover letter? This action cannot be undone.')) {
        // Create a form and submit it using POST method
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("delete_cover_letter", letter_id=cover_letter.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the container
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}